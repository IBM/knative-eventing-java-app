<p align="center">
    <a href="https://cloud.ibm.com">
        <img src="https://landscape.cncf.io/logos/ibm-cloud-kcsp.svg" height="100" alt="IBM Cloud">
    </a>
</p>


<p align="center">
    <a href="https://cloud.ibm.com">
    <img src="https://img.shields.io/badge/IBM%20Cloud-powered-blue.svg" alt="IBM Cloud">
    </a>
    <a href="https://www.ibm.com/developerworks/learn/java/">
    <img src="https://img.shields.io/badge/platform-java-lightgrey.svg?style=flat" alt="platform">
    </a>
    <img src="https://img.shields.io/badge/license-Apache2-blue.svg?style=flat" alt="Apache 2">
</p>


# Create and deploy a Knative Eventing microservice in Java Spring

In this sample application, you will create a basic Java web application using [Knative Eventing](https://knative.dev/docs/eventing/), [Spring](https://spring.io/), and [Cloudant](https://www.ibm.com/cloud/cloudant). This starter kit provides a starting point for creating Java microservice applications that use Knative Eventing and Spring. The application includes a sample event source with [Cron job source](https://knative.dev/docs/eventing/samples/cronjob-source/) and displays events from this source to a web page. This application follows standard best practices, including a health check.

Capabilities are provided through dependencies in the `pom.xml` file. The ports are set to the defaults of `8080` for http and `8443` for https and are exposed to the CLI in the `cli-config.yml` file. The ports are set in the `pom.xml` file and exposed to the CLI in the `cli-config.yml` file.

## Steps

You can [deploy this application to IBM Cloud](https://cloud.ibm.com/developer/appservice/create-app?starterKit=1298bc4e-4764-390b-a9eb-e4dcf3cc03ad) in a Knative-enabled cluster or [build it locally](#building-locally) by cloning this repo first. After your app is live, you can access the `/health` endpoint to test your cloud native application.

*Important:* This application requires a Cloudant service to successfully pass all unit tests. See the [IBM Cloud Catalog](https://cloud.ibm.com/catalog/services/cloudant) to provision a Cloudant service with the free Lite plan if you do not already have one. Also, the application and the Cron job event source must be deployed to a Knative-enabled Kubernetes cluster to support complete Knative Eventing functionality.

### Deploying to IBM Cloud

<p align="center">
    <a href="https://cloud.ibm.com/developer/appservice/create-app?starterKit=1298bc4e-4764-390b-a9eb-e4dcf3cc03ad">
    <img src="https://cloud.ibm.com/devops/setup/deploy/button_x2.png" alt="Deploy to IBM Cloud">
    </a>
</p>

Click **Deploy to IBM Cloud** to deploy this same application to IBM Cloud. This option creates a deployment pipeline, complete with a hosted Gitlab project and DevOps toolchain. You will have the option of deploying to either Cloud Foundry or a Knative-enabled Kubernetes cluster. [IBM Cloud DevOps](https://www.ibm.com/cloud/devops) services provides toolchains as a set of tool integrations that support development, deployment, and operations tasks inside IBM Cloud. Monitor the pipeline stages to ensure successful deployment.

After the application is successfully deployed, you can use the IBM Cloud Developer Tools to deploy the Cron job event source to the same Kubernetes cluster. 

1. Edit the `cronjob-source.yml` file to change the `sink.name` property to the name of the application that will receive events. This name can be found in the `.bluemix/service-knative.yaml` file as the `metadata.name` property.
1. Optionally, change the name `metada.name` property in `cronjob-source.yml` to change the name of the deployed event source.
1. After the Developer Tools are installed and configured, run the following command:

    `kubectl apply -f cronjob-source.yml`

Then visit the `/events` endpoint to view events as they are generated by the Cron job event source. Events are stored in the bound Cloudant database service and can be deleted by visiting the `/events?deleteAll=true` endpoint.

### Building locally

To get started building this application locally, you can either run the application natively or use the [IBM Cloud Developer Tools](https://cloud.ibm.com/docs/cli?topic=cloud-cli-getting-started) for containerization and easy deployment to IBM Cloud.

#### Native application development

* [Maven](https://maven.apache.org/install.html)
* Java 8: Any compliant JVM should work.
  * [Java 8 JDK from Oracle](http://www.oracle.com/technetwork/java/javase/downloads/index.html)
  * [Java 8 JDK from IBM (AIX, Linux, z/OS, IBM i)](http://www.ibm.com/developerworks/java/jdk/),
    or [Download a Liberty server package](https://developer.ibm.com/assets/wasdev/#filter/assetTypeFilters=PRODUCT)
    that contains the IBM JDK (Windows, Linux)

To build and run an application, you must have a Cloudant database service provisioned. Then do one of the following: 
* In the IBM Cloud developer console, navigate to the service's page. Under the **Service Credentials** tab of the service, select **View Credentials** and copy the username, password, and url values to your app's `application.properties` file as follows (or create the file under `src/main/resources` if it does not exist):

  ```
  cloudant_username=62c520dc-9367...  
  cloudant_password=8c03bd171cd99...
  cloudant_url=https://62c520dc-9367...cloudant.com
  ```
* If the IBM Cloud Developer tools are installed, run the `ibmcloud dev get-credentials` command. This command downloads the service credentials into the `src/main/resources/localdev-config.json` file, which is read by the application at runtime. This file is ignored by Git by default and should not be put into source control.

Then run the following commands:
1. `mvn install`
1. `java -jar ./target/knative-eventing-1.0-SNAPSHOT.jar`

To run an application in Docker, use the Docker file named `Dockerfile`. If you do not want to install Maven locally, you can use `Dockerfile-tools` to build a container with Maven installed.

#### IBM Cloud Developer Tools

Install [IBM Cloud Developer Tools](https://cloud.ibm.com/docs/cli?topic=cloud-cli-getting-started) on your machine by running the following command:

```
curl -sL https://ibm.biz/idt-installer | bash
```

Create an application on IBM Cloud by running the following command:

```bash
ibmcloud dev create
```

This command creates and downloads a starter application with the files that are needed for local development and deployment.

Your application will be compiled with Docker containers.

To compile and run your app, run the following commands:

```bash
ibmcloud dev build
ibmcloud dev run
```

The `build` and `run` commands launch your application locally.

When you are ready to deploy to IBM Cloud on Cloud Foundry or Kubernetes, run one of the following commands:

```bash
ibmcloud dev deploy -t buildpack // to Cloud Foundry
ibmcloud dev deploy -t container // to K8s cluster
```

You can build and debug your app locally by running the following commands:

```bash
ibmcloud dev build --debug
ibmcloud dev debug
```

## Next steps
* Learn more about augmenting your Java applications on IBM Cloud with the [Java Programming Guide](https://cloud.ibm.com/docs/java?topic=java-getting-started).
* Explore other [sample applications](https://cloud.ibm.com/developer/appservice/starter-kits) on IBM Cloud.

## License

This sample application is licensed under the Apache License, Version 2. Separate third-party code objects invoked within this code pattern are licensed by their respective providers pursuant to their own separate licenses. Contributions are subject to the [Developer Certificate of Origin, Version 1.1](https://developercertificate.org/) and the [Apache License, Version 2](https://www.apache.org/licenses/LICENSE-2.0.txt).

[Apache License FAQ](https://www.apache.org/foundation/license-faq.html#WhatDoesItMEAN)


